# 暗号化の失敗

## 1. 脅威の概要

暗号化の失敗とは、パスワード、クレジットカード情報、個人情報などの機密データが、転送中（例：HTTP 通信）や保管時（例：データベース内）に適切に暗号化されていなかったり、弱い暗号アルゴリズムが使用されていたりする脆弱性です。これにより、攻撃者に機密情報が窃取・悪用されるリスクが生じます。

## 2. Rails および関連 gem による対策

Ruby on Rails は、機密データの保護に関して、いくつかの重要な機能とベストプラクティスを提供しています。

- **HTTPS の強制:** Rails アプリケーションでは、`config.force_ssl = true` を設定することで、すべての通信を HTTPS 経由に強制できます。これにより、通信経路におけるデータの盗聴や改ざんを防ぎます。本番環境では必須の設定です。
- **パスワードのハッシュ化:** Rails に標準で組み込まれている `has_secure_password` (Active Model) や、devise などの認証 gem は、パスワードをデータベースに保存する際に bcrypt などの強力なハッシュ関数を使用します。これにより、元のパスワードを復元困難にし、万が一データベースが侵害された場合でもパスワードの直接的な漏洩を防ぎます。
- **Active Record Encryption:** Rails 7 からは、Active Record Encryption という機能が導入され、データベースの特定の属性を透過的に暗号化・復号化できるようになりました。これにより、個人情報や API キーなど、パスワード以外の機密データも容易に保護できます。
- **セッション Cookie の保護:** Rails はデフォルトでセッション Cookie を暗号化し、改ざんを防ぐための署名を行います。これにより、セッションハイジャックのリスクを軽減します。
- **Credentials 管理:** Rails には、API キーや外部サービスの認証情報などの機密情報を安全に管理するための `credentials.yml.enc` という仕組みがあります。これにより、リポジトリに直接機密情報をコミットすることなく、安全に設定を管理できます。

## 3. 開発者が追加で注意すべき点

- **適切な暗号化アルゴリズムの選択:** パスワードハッシュ化には bcrypt や Argon2 など、十分に強力で実績のあるアルゴリズムを選択します。独自実装の暗号化や古いアルゴリズム（MD5、SHA1 など）の使用は避けます。
- **鍵管理の徹底:** Active Record Encryption などで使用する暗号鍵は、厳重に管理する必要があります。鍵が漏洩すると暗号化が無意味になるため、Rails の Credentials 機能などを活用し、安全に保管・運用します。
- **TLS/SSL 設定の確認:** Web サーバー（Nginx、Apache など）やロードバランサーの TLS/SSL 設定が適切であることを確認します。古いプロトコルバージョン（SSLv3、TLSv1.0、TLSv1.1 など）や脆弱な暗号スイートを無効化し、強力な設定を維持します。
- **データの種類に応じた暗号化:** すべてのデータを同じように暗号化するのではなく、データの機微性や利用頻度に応じて、適切な暗号化方式（ハッシュ化、対称暗号、非対称暗号など）や暗号化範囲を選択します。
- **バックアップデータの保護:** データベースのバックアップデータも機密情報を含むため、同様に暗号化して保護する必要があります。
- **ログへの機密情報混入防止:** ログファイルにパスワードやクレジットカード番号などの機密情報が誤って記録されないように注意します。Rails のパラメータフィルタリング機能 (`config.filter_parameters`) を活用します。
- **サードパーティサービスとの連携:** 外部 API やサービスと連携する際には、通信が暗号化されているか（HTTPS）、認証情報が安全に取り扱われているかを確認します。
- **定期的な脆弱性診断:** 定期的に脆弱性診断を実施し、暗号化に関する設定ミスや不備がないか確認します。

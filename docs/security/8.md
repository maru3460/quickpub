# ソフトウェアとデータの整合性の不具合

## 1. 脅威の概要

ソフトウェアとデータの整合性の不具合とは、ソフトウェアのアップデートプロセス、機密データ、または CI/CD パイプラインなどが、適切な整合性検証なしに信頼されてしまうことに起因する脆弱性です。これにより、悪意のあるコードやデータがシステムに混入したり、不正なアップデートが適用されたりする可能性があります。例えば、安全でないデシリアライゼーション、信頼できないソースからのプラグインやソフトウェアの導入、CI/CD パイプラインへの不正アクセスなどが該当します。

## 2. Rails および関連 gem による対策

Rails 自体や関連エコシステムは、ソフトウェアとデータの整合性を保つためのいくつかの仕組みや慣習を持っています。

- **Bundler による gem の整合性:** `Gemfile.lock` は、依存する gem の正確なバージョンと、その gem のソース（例：RubyGems.org）を記録します。`bundle install` 時に、これらの情報に基づいて gem が取得されます。RubyGems は gem に署名する機能も提供していますが、検証はデフォルトでは強制されません。
- **Active Record のデータ型とバリデーション:** Active Record はデータ型を強制し、モデルレベルでのバリデーション機能を提供します。これにより、データベースに保存されるデータの基本的な整合性を保つのに役立ちます。
- **CSRF 保護:** Rails はデフォルトでクロスサイトリクエストフォージェリ（CSRF）保護を有効にしており、リクエストの真正性を検証することで、意図しないデータ変更を防ぎます。これはデータの整合性維持に間接的に貢献します。
- **署名付き Cookie/暗号化 Cookie:** Rails は Cookie の内容が改ざんされていないことを保証するために署名付き Cookie を、内容を秘匿するために暗号化 Cookie を提供します。
- **Active Storage のファイルアップロード:** Active Storage はアップロードされたファイルの Content-Type を検証したり、ファイルサイズの制限を設定したりする機能を提供し、不正なファイルのアップロードによるリスクを軽減します。

## 3. 開発者が追加で注意すべき点

- **安全でないデシリアライゼーションの回避:** 信頼できないソースからのデータをデシリアライズする（例：Ruby の`Marshal.load`、YAML の`YAML.load`、JSON のパーサーで特定のオプションを有効にした場合など）ことは避けます。デシリアライズを行う場合は、入力データを厳格に検証し、安全な代替手段（例：JSON のみを許可し、複雑なオブジェクトの再構築は行わない）を検討します。Rails のセッションストアでは、MessageEncryptor/MessageVerifier が使われており、これは比較的安全です。
- **ソフトウェアアップデートの検証:** フレームワーク、ライブラリ、OS などのソフトウェアアップデートを適用する際には、公式の配布元から取得し、可能であればデジタル署名やハッシュ値を検証して、改ざんされていないことを確認します。
- **CI/CD パイプラインのセキュリティ確保:** CI/CD パイプライン（例：Jenkins, GitHub Actions, GitLab CI）へのアクセス制御を厳格に行い、ビルドプロセスやスクリプトの整合性を保護します。不正なコードがデプロイされることを防ぎます。

- **サードパーティライブラリの取得元:** gem は RubyGems.org のような信頼できるソースから取得し、野良 gem の利用は慎重に検討します。JavaScript ライブラリも公式 CDN や信頼できるリポジトリから取得します。
- **データの入力検証とサニタイズ:** 外部から受け取るすべてのデータ（ユーザー入力、API レスポンス、ファイルアップロードなど）は、期待される形式・型・範囲であるかを検証し、必要に応じてサニタイズします。これはインジェクション対策（A03）とも関連しますが、データの整合性維持にも重要です。
- **デジタル署名の活用:** 重要なデータや設定ファイルに対してデジタル署名を利用し、改ざんを検知できるようにすることを検討します。
- **定期的な整合性チェック:** システムの重要なファイルや設定が意図せず変更されていないか、定期的にチェックサムやハッシュ値を用いて確認します。
- **インシデントレスポンス計画:** ソフトウェアやデータの整合性が侵害された場合のインシデントレスポンス計画を準備しておきます。

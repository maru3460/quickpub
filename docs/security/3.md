# インジェクション

## 1. 脅威の概要

インジェクションとは、信頼できないデータがコマンドやクエリの一部としてインタプリタに送信されることで発生する脆弱性です。代表的なものに SQL インジェクションがあり、攻撃者がデータベースクエリを操作して不正なデータを取得したり、データを改ざん・削除したりする可能性があります。他にも、OS コマンドインジェクション、LDAP インジェクション、NoSQL インジェクションなど、様々な種類のインジェクション攻撃が存在します。

## 2. Rails および関連 gem による対策

Ruby on Rails は、特に SQL インジェクションに対して強力な保護機能をデフォルトで提供しています。

- **Active Record による SQL インジェクション対策:** Active Record は、クエリを生成する際にプレースホルダ (`?` や名前付きプレースホルダ) を使用することを推奨しており、これによりユーザー入力は自動的にエスケープ処理され、SQL インジェクションのリスクを大幅に軽減します。例えば、`User.where("name = ?", params[:name])` のように記述することで安全にクエリを構築できます。文字列連結 (`User.where("name = '" + params[:name] + "'")`) のような危険な記述は避けるべきです。
- **HTML エスケープによる XSS 対策:** Rails のビューテンプレート（ERB、Haml など）では、デフォルトで出力される文字列が HTML エスケープされます。これにより、ユーザー入力に含まれる悪意のあるスクリプトがそのまま実行されるクロスサイトスクリプティング（XSS）のリスクを軽減します。意図的にエスケープを解除する場合は `raw` ヘルパーや `html_safe` メソッドを使用しますが、その際は内容が安全であることを十分に確認する必要があります。
- **コマンドインジェクション対策の意識:** Rails 自体が OS コマンドインジェクションを直接防ぐ機能は限定的ですが、外部コマンドを実行する際には `system()` やバッククォートではなく、`Open3`モジュールなどを使用して引数を安全に渡すことが推奨されます。

## 3. 開発者が追加で注意すべき点

- **SQL インジェクションの完全な理解:** Active Record の保護機能に頼るだけでなく、どのような場合に SQL インジェクションが発生しうるかを理解することが重要です。特に、複雑なクエリや生の SQL を記述する必要がある場合は、細心の注意を払い、すべてのユーザー入力を適切にエスケープまたは検証します。
- **マスアサインメントの注意:** Strong Parameters を適切に使用し、意図しない属性が更新されることを防ぎます。これはインジェクションとは直接異なりますが、関連する脆弱性です。
- **OS コマンド実行時の注意:** ユーザーからの入力値を元に OS コマンドを生成・実行する場合は、入力を厳格に検証し、可能な限り固定のコマンドと引数を使用するようにします。`Shellwords.escape` などを利用して引数をエスケープすることも有効です。
- **他のインジェクションへの警戒:** SQL インジェクションや XSS 以外にも、LDAP インジェクション、XPath インジェクション、NoSQL インジェクションなど、使用している技術スタックに応じたインジェクション攻撃の可能性を認識し、対策を講じます。
- **ヘッダインジェクション:** HTTP レスポンスヘッダにユーザー入力をそのまま含めると、ヘッダインジェクション（CRLF インジェクション）を引き起こし、セッション固定や XSS などの攻撃につながる可能性があります。ユーザー入力をヘッダに含める際は、改行文字などを適切に処理します。
- **テンプレートインジェクション:** サーバーサイドテンプレートエンジンを使用している場合、ユーザー入力がテンプレートとして解釈されると、任意のコード実行につながる可能性があります。ユーザー入力をテンプレートに直接埋め込むことは避けます。
- **入力検証の徹底:** すべてのユーザー入力（URL パラメータ、フォームデータ、HTTP ヘッダ、Cookie など）を信頼できないものとして扱い、型、長さ、フォーマット、範囲などを厳格に検証します。
- **出力エンコーディング:** コンテキスト（HTML ボディ、HTML 属性、JavaScript、CSS、URL など）に応じて適切なエンコーディングを行います。Rails の自動エスケープは HTML ボディに対して有効ですが、他のコンテキストでは追加の注意が必要です。
- **Content Security Policy (CSP) の導入:** XSS のリスクをさらに軽減するために、CSP の導入を検討します。CSP は、ブラウザが読み込めるリソースを制限することで、悪意のあるスクリプトの実行を防ぎます。

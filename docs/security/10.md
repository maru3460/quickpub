# サーバーサイドリクエストフォージェリ (SSRF)

## 1. 脅威の概要

サーバーサイドリクエストフォージェリ（SSRF）とは、攻撃者がサーバー側のアプリケーションに、意図しないリクエストを内部ネットワークや外部の任意のサーバーに送信させることができる脆弱性です。アプリケーションがユーザー指定の URL を取得したり、リクエストを転送したりする機能を持つ場合に発生しやすくなります。SSRF が悪用されると、内部システムのポートスキャン、機密情報（例：クラウドプロバイダーのメタデータサービス）へのアクセス、内部サービスへの不正アクセス、さらにはリモートコード実行につながる可能性があります。

## 2. Rails および関連 gem による対策

Rails 自体には SSRF を直接防ぐ包括的な機能は組み込まれていませんが、開発者が SSRF 対策を実装する際に利用できる基本的な HTTP クライアントライブラリ（例：`Net::HTTP`、`HTTParty`、`Faraday`など）を提供しています。SSRF 対策は、これらのライブラリを使用する際の開発者の実装に大きく依存します。

- **URL パーサー:** Ruby の標準ライブラリである `URI` モジュールは URL をパースするために使用できますが、これ自体が SSRF を防ぐわけではありません。パースされた結果を元に、接続先の検証を行う必要があります。

## 3. 開発者が追加で注意すべき点

- **入力検証と許可リスト (Allow List):** ユーザーが指定できる URL やホスト名を厳格に検証し、許可されたドメイン、IP アドレス、ポート番号のリスト（許可リスト）に基づいてアクセスを制限します。拒否リスト（Deny List）はバイパスされる可能性があるため、許可リストの方が安全です。
- **URL スキーマの制限:** HTTP および HTTPS 以外のスキーマ（例：`file://`, `ftp://`, `gopher://`, `dict://`など）を許可しないようにします。特に`gopher://`は任意の TCP 接続を確立できるため危険です。
- **IP アドレス形式の検証:** ユーザー入力が IP アドレス形式（例：`127.0.0.1`, `[::1]`）や特殊なホスト名（例：`localhost`）でないか、あるいは内部ネットワークの IP アドレス範囲でないかを確認します。ただし、DNS リバインディング攻撃などにより、ホスト名から解決される IP アドレスが変化する可能性も考慮する必要があります。
- **リダイレクトの制限:** HTTP リクエストを行う際に、リダイレクトを無効にするか、リダイレクト先の URL も同様に検証します。多くの HTTP クライアントライブラリはデフォルトでリダイレクトに従うため注意が必要です。
- **レスポンスの取り扱い:** サーバーからのレスポンスをユーザーに直接返さないようにします。レスポンスの内容を検証し、必要な情報のみを抽出して利用します。これにより、内部システムの詳細なエラーメッセージなどが漏洩するのを防ぎます。
- **ネットワークレベルの制御:** 可能であれば、アプリケーションサーバーがアクセスできるネットワーク範囲をファイアウォールなどで制限します。特に、クラウド環境のメタデータサービス（例：AWS EC2 の`169.254.169.254`）へのアクセスは厳しく制限する必要があります。
- **専用の HTTP クライアント設定:** 外部へのリクエストを行う際には、タイムアウト値を適切に設定し、不必要なヘッダを送信しないようにします。
- **SSRF に特化したライブラリの利用検討:** SSRF 対策を支援するライブラリやプロキシの利用も検討できますが、そのライブラリ自体の信頼性やメンテナンス状況を確認する必要があります。
- **脆弱性スキャナの利用:** SSRF の脆弱性を検出できるセキュリティスキャナを利用して定期的にテストします。
- **脅威モデリング:** アプリケーションが外部 URL にアクセスするすべての箇所を特定し、SSRF のリスクを評価します。

# ローカル開発環境構築手順

## 1. はじめに

本文書は、「Webサイト公開プラットフォーム」開発プロジェクトのローカル開発環境を構築するための手順を記述します。本プロジェクトではDocker等の仮想環境は使用せず、お使いのOSに直接必要なソフトウェアをインストールして環境を構築します。

OSごとの手順を記載しますが、バージョン差異や個別の環境設定により、手順通りに進まない場合も考えられます。その際は、エラーメッセージや各ソフトウェアの公式ドキュメントを参照してください。

## 2. 対象OS

-   macOS (Intel / Apple Silicon)
-   Windows (WSL2利用を推奨)
-   Linux (Ubuntu LTS版を想定)

## 3. 必要なソフトウェアと推奨バージョン

-   **Ruby**: 3.2.x (プロジェクトの `Gemfile` で指定されたバージョンに合わせるのが理想)
-   **Rails**: 7.x (プロジェクトの `Gemfile` で指定されたバージョン)
-   **Node.js**: 20.x (LTS版を推奨)
-   **Yarn**: 1.22.x (npmでも代用可能ですが、本ドキュメントではYarnを基本とします)
-   **PostgreSQL**: 14.x または 15.x (MySQLでも可能ですが、`config/database.yml` の設定に合わせます。本ドキュメントではPostgreSQLを基本とします)
-   **Git**: 最新版
-   **コードエディタ**: Visual Studio Code (VSCode) を推奨 (拡張機能導入のため)

## 4. OS別インストール手順

### 4.1. macOS

1.  **Homebrew (パッケージマネージャ) のインストール** (未導入の場合):
    ```bash
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    ```

2.  **Git のインストール**:
    ```bash
    brew install git
    ```

3.  **Ruby のインストール (rbenv + ruby-build を推奨)**:
    ```bash
    brew install rbenv ruby-build
    echo 'eval "$(rbenv init -)"' >> ~/.zshrc # ご利用のシェルに合わせて変更 (例: .bash_profile)
    source ~/.zshrc
    # Gemfileに記載のRubyバージョンを確認し、それに合わせてインストール (例: 3.2.2)
    rbenv install 3.2.2
    rbenv global 3.2.2
    gem install bundler # Bundlerのインストール
    ```

4.  **Node.js と Yarn のインストール (nvm を推奨)**:
    ```bash
    brew install nvm
    mkdir ~/.nvm
    echo 'export NVM_DIR="$HOME/.nvm"' >> ~/.zshrc
    echo '[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && . "/opt/homebrew/opt/nvm/nvm.sh"  # For Apple Silicon' >> ~/.zshrc
    echo '[ -s "/usr/local/opt/nvm/nvm.sh" ] && . "/usr/local/opt/nvm/nvm.sh"  # For Intel Macs' >> ~/.zshrc
    source ~/.zshrc
    nvm install 20 # LTS版 (例: 20.x.x)
    nvm use 20
    npm install -g yarn # Yarnのインストール
    ```

5.  **PostgreSQL のインストール**:
    ```bash
    brew install postgresql@14 # バージョンはプロジェクトに合わせる
    brew services start postgresql@14
    # 必要に応じてユーザー作成
    # createuser -s postgres # スーパーユーザーとしてpostgresを作成 (ローカル開発用)
    ```

### 4.2. Windows (WSL2利用推奨)

Windowsで開発する場合、WSL2 (Windows Subsystem for Linux 2) 上にLinuxディストリビューション (Ubuntu推奨) を導入し、その中で開発環境を構築することを強く推奨します。

1.  **WSL2 と Ubuntu のインストール**:
    *   Microsoft Storeから「Ubuntu」を検索してインストールするか、PowerShellで以下のコマンドを実行します。
        ```powershell
        wsl --install -d Ubuntu
        ```
    *   詳細はMicrosoftの公式ドキュメントを参照してください: [https://learn.microsoft.com/ja-jp/windows/wsl/install](https://learn.microsoft.com/ja-jp/windows/wsl/install)

2.  **Ubuntu環境でのセットアップ** (WSL2上のUbuntuターミナルで実行):
    *   **パッケージリストの更新**:
        ```bash
        sudo apt update && sudo apt upgrade -y
        ```
    *   **Git のインストール**:
        ```bash
        sudo apt install git -y
        ```
    *   **Ruby のインストール (rbenv + ruby-build を推奨)**:
        ```bash
        sudo apt install -y autoconf bison build-essential libssl-dev libyaml-dev libreadline6-dev zlib1g-dev libncurses5-dev libffi-dev libgdbm-dev
        git clone https://github.com/rbenv/rbenv.git ~/.rbenv
        echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc
        echo 'eval "$(rbenv init -)"' >> ~/.bashrc
        source ~/.bashrc
        git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
        # Gemfileに記載のRubyバージョンを確認し、それに合わせてインストール (例: 3.2.2)
        rbenv install 3.2.2
        rbenv global 3.2.2
        gem install bundler
        ```
    *   **Node.js と Yarn のインストール (nvm を推奨)**:
        ```bash
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash # 最新版はNVMのGitHubで確認
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
        source ~/.bashrc
        nvm install 20 # LTS版 (例: 20.x.x)
        nvm use 20
        npm install -g yarn
        ```
    *   **PostgreSQL のインストール**:
        ```bash
        sudo apt install postgresql postgresql-contrib libpq-dev -y
        sudo systemctl start postgresql
        sudo systemctl enable postgresql
        # 必要に応じてユーザー作成 (psqlコマンドで)
        # sudo -u postgres createuser --interactive --pwprompt
        # (ユーザー名: プロジェクトのdatabase.ymlに合わせるか、ローカルPCのユーザー名など)
        # (スーパーユーザーにしますか？ yes)
        # sudo -u postgres createdb <your_db_name_development> -O <your_username>
        ```

### 4.3. Linux (Ubuntu LTS版想定)

WSL2上のUbuntuと同様の手順でインストール可能です。上記「4.2. Windows (WSL2利用推奨)」の「Ubuntu環境でのセットアップ」セクションを参照してください。

## 5. プロジェクトのセットアップ

1.  **プロジェクトのクローン**:
    ```bash
    git clone <リポジトリのURL> my_rails_project
    cd my_rails_project
    ```

2.  **Rails側のセットアップ**:
    *   **Rubyバージョンの確認と適用** (rbenv利用時):
        ```bash
        rbenv local 3.2.2 # プロジェクトの.ruby-versionファイルがあれば自動で適用されることも
        ```
    *   **Gemのインストール**:
        ```bash
        bundle install
        ```
    *   **データベース設定ファイルの準備**:
        `config/database.yml` を確認し、ローカルのPostgreSQL設定 (ユーザー名、パスワードなど) に合わせて修正します。通常、`config/database.yml.example` があればコピーして作成します。
        ```bash
        cp config/database.yml.example config/database.yml
        # nano config/database.yml などで編集
        ```
        開発環境の `username` と `password` を適切に設定してください。
    *   **データベースの作成とマイグレーション**:
        ```bash
        rails db:create
        rails db:migrate
        # 必要に応じてシードデータの投入
        # rails db:seed
        ```

3.  **React側 (`client/` ディレクトリ) のセットアップ**:
    *   **Node.jsバージョンの確認と適用** (nvm利用時):
        ```bash
        cd client
        nvm use # プロジェクトルートに .nvmrc ファイルがあれば自動で適用
        ```
    *   **依存パッケージのインストール**:
        ```bash
        yarn install # または npm install
        cd .. # プロジェクトルートに戻る
        ```

4.  **環境変数ファイル (`.env`) の準備** (もしあれば):
    プロジェクトルートに `.env.example` があればコピーして `.env` を作成し、必要な環境変数を設定します。
    ```bash
    cp .env.example .env
    # nano .env などで編集
    ```

## 6. サーバー起動

-   **Railsサーバーの起動** (プロジェクトルートで):
    ```bash
    rails server
    ```
    デフォルトでは `http://localhost:3000` で起動します。

-   **React開発サーバーの起動** (新しいターミナルを開き、`client/` ディレクトリで):
    ```bash
    cd client
    yarn dev # または npm run dev (package.jsonのscriptsを確認)
    ```
    通常、`http://localhost:3001` や `http://localhost:5173` (Viteの場合) など、Railsサーバーとは異なるポートで起動します。

## 7. VSCode拡張機能 (推奨)

-   **Ruby**: `Shopify.ruby-lsp` または `rebornix.Ruby`
-   **Rails**: `bung87.rails`
-   **RSpec**: `vortizhe.simple-ruby-rspec`
-   **Node.js / JavaScript / TypeScript**: `dbaeumer.vscode-eslint`, `esbenp.prettier-vscode` (Biomeを使う場合はBiomeの拡張機能)
-   **Biome**: `biomejs.biome` (Biomeを利用する場合)
-   **Git**: `eamodio.gitlens`
-   **PostgreSQL**: `cweijan.vscode-postgresql-client2` (DB操作用)
-   **DotENV**: `mikestead.dotenv` (`.env`ファイル用)

## 8. トラブルシューティング

-   **Gemインストールエラー**: `libpq-dev` (PostgreSQL), `libxml2-dev`, `libxslt-dev` (Nokogiri) など、必要な開発ライブラリが不足している可能性があります。エラーメッセージをよく読み、不足しているライブラリをインストールしてください。
-   **DB接続エラー**: `config/database.yml` の設定が正しいか、PostgreSQLサーバーが起動しているか、ユーザー権限が適切かなどを確認してください。
-   **Yarn/npmエラー**: Node.jsのバージョンが適切か、`node_modules` ディレクトリを一度削除して再インストール (`rm -rf node_modules && yarn install`) すると解決することがあります。

この手順書は基本的なものであり、プロジェクトの特性や個々の環境によって追加の調整が必要になる場合があります。不明な点や問題が発生した場合は、エラーメッセージを検索したり、関連ドキュメントを参照してください。
